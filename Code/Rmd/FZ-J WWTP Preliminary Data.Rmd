---
title: 'FZ-J WWTP ATS: Preliminary Data'
author: "Dean Calahan"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, fig.height=3)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```
```{r initialize}
library(readr)
library(dplyr)
library(lubridate)
source("Code/R/Settings.R")
```

```{r CleanHOBOData}
CleanHOBOData <- function(fn, trim=c(NA, NA), wind=c(NA, NA), view=TRUE, text=FALSE, ret=FALSE) {
# i:
# fn        Name of the HOBO csv file to load. Assumption: see column names in read_csv call below.
# trim      Number of observations to remove from beginning and end of data
# wind      Beginning and end indexes of data to plot
# view      Whether to plot the data
# text      Whether to display text with count of observations in the csv file
# ret       Whether to return the trimmed dataset
#
    tb <- read_csv(paste0(csvdir, fn), skip=2, col_names=c(
        "id",
        "date",
        "time",
        "tmp",
        "lx")) %>% transmute(
            datetime = make_datetime(year(mdy(date)),
                                     month(mdy(date)),
                                     day(mdy(date)),
                                     hour(time),
                                     minute(time),
                                     second(time),
                                     tz="Europe/Berlin"),
            temp=tmp,
            lux=lx
        )
    
    row_ct <- nrow(tb)
    
    if(is.na(trim[[1]])) {
        trim <- c(0, row_ct)
    } else {
        trim <- c(trim[[1]], row_ct - trim[[2]])
    }

    if(is.na(wind[[1]])) {
        wind <- c(1, row_ct)
    }

    if(text) {
        cat(paste0(fn, ": ", nrow(tb), " ", "observations\n"))
    }
    
    if(view) {
        par(mfrow=c(1,2))
        
        plot(x=tb[wind[[1]]:wind[[2]],]$datetime,
             y=tb[wind[[1]]:wind[[2]],]$lux,
             type="l",
             main=paste0("lux ", fn),
             xlab="Date",
             ylab="Lux")
        
        abline(v=c(tb[trim[[1]],]$datetime,
                   tb[trim[[2]],]$datetime),
               col=c("blue", "blue"),
               lty=c(1, 1),
               lwd=c(1, 1))
        
        plot(x=tb[wind[[1]]:wind[[2]],]$datetime,
             y=tb[wind[[1]]:wind[[2]],]$temp,
             type="l",
             main=paste0("temp ", fn),
             xlab="Date",
             ylab="Temperature")
        
        abline(v=c(tb[trim[[1]],]$datetime,
                   tb[trim[[2]],]$datetime),
               col=c("blue", "blue"),
               lty=c(1, 1),
               lwd=c(1, 1))
        
    }
    
    if(ret) {
        return(tb[trim[[1]]:trim[[2]],])
    }
}

HOBODataSection <- function(fn, l, r) {
    tb <- ViewHOBOData(fn, view=FALSE, ret=TRUE)
    row_ct <- nrow(tb)
    triml <- 1010
    trimr <- 365
    ViewHOBOData(fn, trim=c(l, r))
    ViewHOBOData(fn, trim=c(l, r), wind=c(l-50, l+50))
    ViewHOBOData(fn, trim=c(l, r), wind=c(row_ct-r-50, row_ct-r+50))
    return(tb[l:(row_ct-r),])
}

files <- c("ATS_1.11.09.18.csv",
           "ATS_2.17.09.18.csv",
           "ATS_1.24.09.18.csv",
           "ATS_2.01.10.18.csv",
           "ATS_1.08.10.18.csv",
           "ATS_2.15.10.18.csv",
           "ATS_1.22.10.18.csv")
```

# Introduction  
Forshungzentrum-JÃ¼lich's (FZ-J) IBG-2 Alternative Biomass group installed a pilot
algal turf scrubber (ATS) at its campus wastewater treatment plant (WWTP) in mid-August
of 2018. This facility comprised a dump bucket and floway with approximately 1m^2^
algal growth area, and recirculated 500 L of secondary treated sewage for periods
of 24 hr (Monday through Thursday) and 96 hr (Thursday through Sunday). Beginning
in early September, the facility was harvested weekly, and elementary water chemistry,
illumination, temperature, and biomass productivity data were collected. The facility
was removed from the WWTP at the end of September. This document describes the data
collection for this pilot project and summarizes the results.  

## Cleaning of Illumination and Temperature Data  
Two HOBO data loggers (ATS_1 and ATS_2) were used to gather temperature and illumination
data, with one observation recorded per minute. The loggers were exchanged each week.
Here we read the individual HOBO csv files and clean the data. To clean the data we need
to trim away observations that were not taken while the data logger was actually
installed in the floway. We open each file in order and determine which observations
need to be removed by visual inspection. The following sections plot each complete
data set, with blue vertical lines enclosing the window of valid observations. Each
complete plot is followed my magnifications of each cutoff region.

### Week 1 (ATS_1)
```{r week1}
week1data <- CleanHOBOData(files[[1]], view=FALSE, ret=TRUE)
row_ct <- nrow(week1data)
triml <- 1010
trimr <- 365
CleanHOBOData(files[[1]], trim=c(triml, trimr))
CleanHOBOData(files[[1]], trim=c(triml, trimr), wind=c(triml-50, triml+50))
CleanHOBOData(files[[1]], trim=c(triml, trimr), wind=c(row_ct-trimr-50, row_ct-trimr+50))
week1data <- week1data[triml:(row_ct-trimr),]
```

For this first file, both data loggers were initialized in the afternoon,
and then ATS_1 was installed the next morning. We first glimpse the whole file. We see
six complete days worth of observations and the beginning of a sixth day. Illumination ranges
from 0 lux (darkness) to well above 150.000 lux (full sunlight), whereas temperature shows
an expected rise and fall each day. As
there are 10.028 observations total, The first 1.500 or so observations must contain the time at which the logger was installed.
\newpage

```{r week2}
week2data <- CleanHOBOData(files[[2]], ret=TRUE)
row_ct <- nrow(week2data)
triml <- 9773
trimr <- 271
CleanHOBOData(files[[2]], trim=c(triml, trimr))
CleanHOBOData(files[[2]], trim=c(triml, trimr), wind=c(triml-50, triml+50))
CleanHOBOData(files[[2]], trim=c(triml, trimr), wind=c(row_ct-trimr-50, row_ct-trimr+50))
week2data <- week2data[triml:(row_ct-trimr),]
```

Here we zoom in to the first 1.500 observations. To the left of the illumination
observations are low peaks representing light levels inside 
Dean's office, followed by a period of darkness, then a series of peaks
representing dawn and Dean taking ATS_1 out to the floway. The temperature profile is more
revealing, with a high afternoon temperature falling off smoothly over the night, dawn bringing in
some heat, followed by placing the HOBO into the cool water of the floway.

```{r week3}
week3data <- CleanHOBOData(files[[3]], ret=TRUE)
row_ct <- nrow(week3data)
triml <- 119
trimr <- 96
CleanHOBOData(files[[3]], trim=c(triml, trimr))
CleanHOBOData(files[[3]], trim=c(triml, trimr), wind=c(triml-50, triml+50))
CleanHOBOData(files[[3]], trim=c(triml, trimr), wind=c(row_ct-trimr-50, row_ct-trimr+50))
week3data <- week3data[triml:(row_ct-trimr),]
```

Here we zoom in to where the temperature really drops off around 8:30, representing
placing the HOBO into the water, then zoom in further to deterimine the precise initial observation,
which is #1009. Thus we know to trim observations from 1:1008 in this file, with the first relevant observation
at `r week1data[2,]$datetime`.

```{r week4}
week4data <- CleanHOBOData(files[[4]], ret=TRUE)
row_ct <- nrow(week4data)
triml <- 107
trimr <- 227
CleanHOBOData(files[[4]], trim=c(triml, trimr))
CleanHOBOData(files[[4]], trim=c(triml, trimr), wind=c(triml-50, triml+50))
CleanHOBOData(files[[4]], trim=c(triml, trimr), wind=c(row_ct-trimr-50, row_ct-trimr+50))
week4data <- week4data[triml:(row_ct-trimr),]
```

Here we wish to determine the end of the Week 1 recording period for HOBO ATS_1. Here we
zoom in on the last 1.500 observations and observe that on Tuesday morning illumination starts
to rise but then drops off sharply as ATS_1 is removed from the floway and stowed. Zooming
in further reveals that observation #9663 is the one after which the Lux declines, thus we
know to select observations 1009:9663 for the cleaned Week 1 data.
\newpage
### Week 2 (ATS_2)   
```{r week5}
week5data <- CleanHOBOData(files[[5]], ret=TRUE)
row_ct <- nrow(week5data)
triml <- 107
trimr <- 227
CleanHOBOData(files[[5]], trim=c(triml, trimr))
CleanHOBOData(files[[5]], trim=c(triml, trimr), wind=c(triml-50, triml+50))
CleanHOBOData(files[[5]], trim=c(triml, trimr), wind=c(row_ct-trimr-50, row_ct-trimr+50))
week5data <- week5data[triml:(row_ct-trimr),]
```

Here we see the total data for ATS_2, which was initiliazed at the same time as ATS_1, but
left in Dean's office. We know when ATS_1 was removed from the floway; ATS_2 was installed
probably no more than an hour after that.

```{r week6}
week6data <- CleanHOBOData(files[[6]], ret=TRUE)
row_ct <- nrow(week6data)
triml <- 121
trimr <- 65
CleanHOBOData(files[[6]], trim=c(triml, trimr))
CleanHOBOData(files[[6]], trim=c(triml, trimr), wind=c(triml-50, triml+50))
CleanHOBOData(files[[6]], trim=c(triml, trimr), wind=c(row_ct-trimr-50, row_ct-trimr+50))
week6data <- week6data[triml:(row_ct-trimr),]
```
Here we determine the first observation from Week2 that is later than the last observation
from the cleaned Week 1 data (#`r triml`, corresponding to `r week2data[triml,]$datetime`).
We then zoom in on the 120 observations starting 10 minutes before that one. We
observe a distinct rise in illumination that corresponds with a steep decline in
temperature as ATS_2 is retrieved and placed in the water flow. We then zoom in
closer to determine the exact observation corresponding to this event. Unsurprisingly,
this appears to be the one immediately following the one when ATS_1 was removed,
or `r triml+1`. We then zoom in on the end of the observations as with week 1 to determine
the final relevant observation, focusing on the moment when both illumination and
temperature begin to fall rapidly. This occurs at observation `r format(trimr-271, scientific=FALSE)`.


```{r week7}
week7data <- CleanHOBOData(files[[7]], ret=TRUE)
row_ct <- nrow(week7data)
triml <- 84
trimr <- 54
CleanHOBOData(files[[7]], trim=c(triml, trimr))
CleanHOBOData(files[[7]], trim=c(triml, trimr), wind=c(triml-50, triml+50))
CleanHOBOData(files[[7]], trim=c(triml, trimr), wind=c(row_ct-trimr-50, row_ct-trimr+50))
week7data <- week7data[triml:(row_ct-trimr),]
```
