---
title: 'FZ-J WWTP ATS: Preliminary Data'
author: "Dean Calahan"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, fig.height=3)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```
```{r initialize}
library(readr)
library(dplyr)
library(lubridate)
source("Code/R/Settings.R")
```

```{r Code}
HOBOData <- function(fn, trim=c(NA, NA), wind=c(NA, NA), view=TRUE, text=FALSE, ret=FALSE) {
# i:
# fn        Name of the HOBO csv file to load. Assumption: see column names in read_csv call below.
# trim      Number of observations to remove from beginning and end of data
# wind      Beginning and end indexes of data to plot
# view      Whether to plot the data
# text      Whether to display text with count of observations in the csv file
# ret       Whether to return the trimmed dataset
#
    tb <- read_csv(paste0(csvdir, fn), skip=2, col_names=c(
        "id",
        "date",
        "time",
        "tmp",
        "lx")) %>% transmute(
            datetime = make_datetime(year(mdy(date)),
                                     month(mdy(date)),
                                     day(mdy(date)),
                                     hour(time),
                                     minute(time),
                                     second(time),
                                     tz="Europe/Berlin"),
            temp=tmp,
            lux=lx
        )
    
    row_ct <- nrow(tb)
    
    if(is.na(trim[[1]])) {
        trim <- c(0, row_ct)
    } else {
        trim <- c(trim[[1]], row_ct - trim[[2]])
    }

    if(is.na(wind[[1]])) {
        wind <- c(1, row_ct)
    }

    if(text) {
        cat(paste0(fn, ": ", nrow(tb), " ", "observations\n"))
    }
    
    if(view) {
        par(mfrow=c(1,2))
        
        plot(x=tb[wind[[1]]:wind[[2]],]$datetime,
             y=tb[wind[[1]]:wind[[2]],]$lux,
             type="l",
             main=paste0("lux ", fn),
             xlab="Date",
             ylab="Lux")
        
        abline(v=c(tb[trim[[1]],]$datetime,
                   tb[trim[[2]],]$datetime),
               col=c("blue", "blue"),
               lty=c(1, 1),
               lwd=c(1, 1))
        
        plot(x=tb[wind[[1]]:wind[[2]],]$datetime,
             y=tb[wind[[1]]:wind[[2]],]$temp,
             type="l",
             main=paste0("temp ", fn),
             xlab="Date",
             ylab="Temperature")
        
        abline(v=c(tb[trim[[1]],]$datetime,
                   tb[trim[[2]],]$datetime),
               col=c("blue", "blue"),
               lty=c(1, 1),
               lwd=c(1, 1))
        
    }
    
    if(ret) {
        return(tb[trim[[1]]:trim[[2]],])
    }
}

CleanHOBOData <- function(fn, l, r) {
    tb <- HOBOData(fn, view=FALSE, ret=TRUE)
    row_ct <- nrow(tb)
    triml <- 1010
    trimr <- 365
    HOBOData(fn, trim=c(l, r))
    HOBOData(fn, trim=c(l, r), wind=c(l-50, l+50))
    HOBOData(fn, trim=c(l, r), wind=c(row_ct-r-50, row_ct-r+50))
    return(tb[l:(row_ct-r),])
}

files <- c("ATS_1.11.09.18.csv",
           "ATS_2.17.09.18.csv",
           "ATS_1.24.09.18.csv",
           "ATS_2.01.10.18.csv",
           "ATS_1.08.10.18.csv",
           "ATS_2.15.10.18.csv",
           "ATS_1.22.10.18.csv")
```

# Introduction  
Forshungzentrum-JÃ¼lich's (FZ-J) IBG-2 Alternative Biomass group installed a pilot
algal turf scrubber (ATS) at its campus wastewater treatment plant (WWTP) in mid-August
of 2018. This facility comprised a dump bucket and floway with approximately 1m^2^
algal growth area, and recirculated 500 L of secondary treated sewage for periods
of 24 hr (Monday through Thursday) and 96 hr (Thursday through Sunday). Beginning
in early September, the facility was harvested weekly, and elementary water chemistry,
illumination, temperature, and biomass productivity data were collected. The facility
was removed from the WWTP at the end of September. This document describes the data
collection for this pilot project and summarizes the results.  

## Temperature and Illumination Data  
Two HOBO data loggers (ATS_1 and ATS_2) were used to gather temperature and illumination
data, with one observation recorded per minute. The loggers were exchanged each week as part of the harvesting protocol.
We read each HOBO csv file and clean the data by removing observations not taken while the data logger was
installed in the floway. We open each file in order and determine which observations
need to be removed by visual inspection. The following sections plot each complete
data set, with blue vertical lines enclosing the window of valid observations. Each
complete plot is followed my magnifications of each cutoff region. During the data cleaning process, the cleaned data
is accumulated into a single data frame and then saved.

# Figures  
### Temperature and Illumination, Week 1 (ATS_1)  
```{r week1}
data <- CleanHOBOData(files[1], 1010, 365)
```

### Temperature and Illumination, Week 2 (ATS_2)  
```{r week2}
data <- data %>% rbind(CleanHOBOData(files[2], 9773, 271))
```

### Temperature and Illumination, Week 3 (ATS_1)  
```{r week3}
data <- data %>% rbind(CleanHOBOData(files[3], 119, 96))
```

### Temperature and Illumination, Week 4 (ATS_2)  
```{r week4}
data <- data %>% rbind(CleanHOBOData(files[4], 107, 227))
```

### Temperature and Illumination, Week 5 (ATS_1)  
```{r week5}
data <- data %>% rbind(CleanHOBOData(files[5], 107, 227))
```

### Temperature and Illumination, Week 6 (ATS_2)  
```{r week6}
data <- data %>% rbind(CleanHOBOData(files[6], 121, 65))
```

### Temperature and Illumination, Week 7 (ATS_1)  
```{r week7}
data <- data %>% rbind(CleanHOBOData(files[7], 84, 54))
write_csv(data, "Data/csv/FZJATSPilot.csv")
```
