---
title: 'FZ-J WWTP ATS Pilot'
subtitle: 'Data Cleaning'
author:
- Dean Calahan^[Smithsonian Institution]
- Isabel Meuser^[Forschungszentrum Jülich]
- Ladislav Nedbal^[Forschungszentrum Jülich]
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, fig.height=3)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```
```{r initialize}
library(readr)
library(readxl)
library(dplyr)
library(lubridate)
library(knitr)
source("Code/R/Settings.R")
source("Code/R/FZJWWTPP.R")
```

# Introduction  
Forshungzentrum-Jülich's (FZ-J) IBG-2 Alternative Biomass group installed a pilot
algal turf scrubber (ATS) at FZ-J's campus wastewater treatment plant (WWTP) in mid-August
of 2018. This facility comprised a dump bucket and floway with approximately 1m^2^
algal growth area, and recirculated 500 L of secondary treated sewage for intervals
of 24 hr (Monday through Thursday) and 96 hr (Thursday through Sunday). Beginning
in early September, algal biomass was harvested weekly, and water chemistry,
illumination, temperature, and biomass productivity data were collected. The facility
was removed from the WWTP at the end of September. This document describes the data
collection for this pilot project and summarizes the results.  

# Data Collection  

## Temperature and Illumination  
Two HOBO data loggers, ATS_1 and ATS_2, (Onset Computer Corporation, Bourne, MA,
USA), were used to gather temperature data in degrees Celsius and illumination data
in lux, with one observation recorded each minute. Each week one logger was installed
in the floway, while the other logger was idle. Prior to biomass harvest, the idle
logger was initialized used to replace the previously active logger after harvest.
Data was downloaded and processed using HOBOware 3.7.15 (Onset Computer Corporation,
Bourne, MA, USA), to export `csv` files containing the temperature and illumination
readings. The `csv` files were analyzed in R 3.4.2 using RStudio 1.0.143.

The data from each `csv` file (Table 1) was cleaned by plotting and visual inspection to determine
which observations referred to the logger's residence time within the floway. Results
of this analysis are shown in Figures 1-7. Each weekly plot (panel A) is followed
by magnifications of each cutoff region (panels B and C). In general it was obvious
from temperature and/or illumination readings which were the relevant readings.
Irrelevant readings were discarded and the remaining readings were aggregated into
a single data frame and exported to the file `FZJATSPilot.csv`.

## Water Chemistry and Biomass  
Total nitrogen and $\mathrm{PO}_4$ phosphate determinations were performed on daily samples taken
before and after water exchange. Samples not assayed on the day they were taken were frozen and
assayed later. On two occasions, samples were assayed both on the day they were taken and
after freezing (Table 2). As the differences between the readings for frozen and unfrozen samples
was smalls

# Data Analaysis

# Figures  
```{r, out.width=300, echo=FALSE}
knitr::include_graphics("http://apod.nasa.gov/apod/image/1302/ringshexagon_cass
ini_1016.jpg")
```
### Temperature and Illumination, Week 1 (ATS_1)  
```{r week1}
ti_df <- CleanHOBOData(csvfiles[1], 1010, 365, w=1)
```

### Temperature and Illumination, Week 2 (ATS_2)  
```{r week2}
ti_df <- ti_df %>% rbind(CleanHOBOData(csvfiles[2], 9773, 271, w=2))
```

### Temperature and Illumination, Week 3 (ATS_1)  
```{r week3}
ti_df <- ti_df %>% rbind(CleanHOBOData(csvfiles[3], 119, 96, w=3))
```

### Temperature and Illumination, Week 4 (ATS_2)  
```{r week4}
ti_df <- ti_df %>% rbind(CleanHOBOData(csvfiles[4], 107, 227, w=4))
```

### Temperature and Illumination, Week 5 (ATS_1)  
```{r week5}
ti_df <- ti_df %>% rbind(CleanHOBOData(csvfiles[5], 107, 227, w=5))
```

### Temperature and Illumination, Week 6 (ATS_2)  
```{r week6}
ti_df <- ti_df %>% rbind(CleanHOBOData(csvfiles[6], 121, 65, w=6))
```

### Temperature and Illumination, Week 7 (ATS_1)  
```{r week7}
ti_df <- ti_df %>% rbind(CleanHOBOData(csvfiles[7], 84, 54, w=7))
write_csv(ti_df, paste0(datadir, "FZJATSPilot.csv"))
```

# Floway Chemistry & Biomass
```{r Floway}
wc_df <- read_excel(chemfile,
                    sheet="Tabelle1",
                    skip=3,
                    col_names=c("date",
                               "time",
                               "beforeafter",
                               "PO4dil",
                               "PO4P",
                               "PO4Pxdil",
                               "PO4Pred",
                               "dilTN",
                               "TNxdil",
                               "TN",
                               "TNred",
                               "comment",
                               "remark",
                               "assaydate",
                               "bmwet",
                               "bmdry",
                               "bmdrypct",
                               "pH"))

# Impute missing times. We take the minimum time, and simply add 24 hours to it
no_times <- which(is.na(wc_df$time))
min_time <- min(ti_df[ti_df$week == 1,]$datetime)
wc_df[which(is.na(wc_df$time)),]$time <- make_datetime(2018,
                                                       12,
                                                       31,
                                                       8,
                                                       0,
                                                       0)

# Create a new data frame with date and time combined into datetime for each observation
fw_df <- data.frame(datetime=make_datetime(year(wc_df$date),
                                           month(wc_df$date),
                                           day(wc_df$date),
                                           hour(wc_df$time),
                                           minute(wc_df$time),
                                           second(wc_df$time),
                                           tz="Europe/Berlin"))

# Make before/after a logical
fw_df$before <- TRUE
fw_df[which(wc_df$beforeafter != "before"),]$before <- FALSE

# Nutrient concentrations & pH
fw_df$PO4P <- wc_df$PO4Pxdil
fw_df$TN <- wc_df$TN
fw_df$pH <- wc_df$pH

# Make frozen/not frozen a logical
fw_df$frozen <- TRUE
fw_df[which(wc_df$comment != "frozen"),]$frozen <- FALSE

# Date of assay
fw_df$assaydate <- make_date(year(wc_df$assaydate),
                                 month(wc_df$assaydate),
                                 day(wc_df$assaydate))

# Add a week number corresponding to ti_df
# week_num_dates <- function(x) {
#     t <- unique(make_date(year(ti_df[ti_df$week == x,]$datetime),
#                      month(ti_df[ti_df$week == x,]$datetime),
#                      day(ti_df[ti_df$week == x,]$datetime)))
#     return(c(min(t), max(t)))
# }
# t <- week_num_dates(1)
# which(fw_df$datetime >= t[1] & fw_df$datetime <= t[2])

# Biomass measurements
fw_df$wet_biomass <- wc_df$bmwet
fw_df$dry_biomass <- wc_df$bmdry
fw_df$solids <- wc_df$bmdrypct

# Need observation date separately to make life easier
fw_df$obsdate <- make_date(year(fw_df$datetime), month(fw_df$datetime), day(fw_df$datetime))
```

## Correlation of nutrient removal with temperature and illumination.  
We initially assume that nutrient removal is a function of algal metabolic activity,
which itself we assume is a function of temperature and illumination. We first
integrate these observations for each nutrient assay interval by converting degrees
Celsius to degrees Kelvin, summing the temperatures and illumination readings for each
interval to obtain values for "degree minutes" (DM) and "lux minutes" (LM). For each interval
we then multiply DM $\times$ LM and plot these values against nutrient removal for that interval.

```{r DMLM}
# A global list of unique dates of nutrient assays
nutdates <- sort(unique(make_date(year(fw_df$datetime), month(fw_df$datetime), day(fw_df$datetime))))

IntegrateObs <- function(day, diag=FALSE) {
#
# i:    startdate
#
# o:    The number of degree minutes between the observation time of the given start date
#       and the next observation time
#
# g:    
#
    # Day 1 is an error because there was no previous sample
    if(day == 1) {
        stop("Day 1 illegal")
    }
    
    # If day is larger than number of observations, it is an error
    if(day > length(nutdates)) {
        stop("Day too large")
    }
    
    # What are the bracketing datetimes
    t2 <- min(fw_df[which(year(fw_df$datetime) == year(nutdates[day]) &
                         month(fw_df$datetime) == month(nutdates[day]) &
                         day(fw_df$datetime) == day(nutdates[day])),]$datetime)
    
    t1 <- min(fw_df[which(year(fw_df$datetime) == year(nutdates[day-1]) &
                         month(fw_df$datetime) == month(nutdates[day-1]) &
                         day(fw_df$datetime) == day(nutdates[day-1])),]$datetime)
    
    # What are the temperature and lux measurements between these brackets?
    temps <- ti_df[ti_df$datetime >= t1 & ti_df$datetime < t2,]$temp + C2K
    luxs <-  ti_df[ti_df$datetime >= t1 & ti_df$datetime < t2,]$lux
    
    if(diag) {
        cat(paste0("Number of observations: ", length(temps), "\n"))
    }
    
    return(c(sum(temps), sum(luxs)))
}

int_obs <- t(simplify2array(lapply(2:26, IntegrateObs)))
obs_df <- data.frame(datetime=nutdates[2:26], temps=int_obs[,1], luxs=int_obs[,2])
barplot(height=obs_df$temps, names.arg=obs_df$datetime)
barplot(height=obs_df$lux, names.arg=obs_df$datetime)
```

To integrate temperature and illumination data we sum the values (after converting temperature from degrees
Celsius to degrees Kelvin) approximate for each interval between N and P assays. 

## Validity of nutrient assays of frozen samples
```{r Frozen}
# Which assays had results for both frozen and non-frozen samples?
#
# First get indices of before/after for frozen/nonfrozen samples
nf_before <- which(fw_df$frozen == FALSE & fw_df$before == TRUE)
nf_after <- which(fw_df$frozen == FALSE & fw_df$before == FALSE)
f_before <- which(fw_df$frozen == TRUE & fw_df$before == TRUE)
f_after <- which(fw_df$frozen == TRUE & fw_df$before == FALSE)

# Then, for each assay that was frozen, was there a frozen assay for that date,
# And for each assay that wasn't frozen, was there an unfrozen assay for that date
both_before_nf <- fw_df[nf_before,]$obsdate %in% fw_df[f_before,]$obsdate
both_after_nf <- fw_df[nf_after,]$obsdate %in% fw_df[f_after,]$obsdate
both_before_f <- fw_df[f_before,]$obsdate %in% fw_df[nf_before,]$obsdate
both_after_f <- fw_df[f_after,]$obsdate %in% fw_df[nf_after,]$obsdate

# What are the dates for all those
nf_before_dates <- fw_df[nf_before[both_before_nf],]$obsdate
# nf_after_dates <- fw_df[nf_after[both_after_nf],]$obsdate
# f_before_dates <- fw_df[f_before[both_before_f],]$obsdate
# f_after_dates <- fw_df[f_after[both_after_f],]$obsdate

# What are the differences between the measurements
N_nf_before <- fw_df[nf_before[both_before_nf],]$TN
N_f_before <- fw_df[f_before[both_before_f],]$TN
P_nf_before <- fw_df[nf_before[both_before_nf],]$PO4P
P_f_before <- fw_df[f_before[both_before_f],]$PO4P

N_rat <- (N_nf_before - N_f_before) / N_nf_before
P_rat <- (P_nf_before - P_f_before) / P_nf_before
```
Samples taken on `r nf_before_dates[1]` and `r nf_before_dates[2]` were assayed both
immediately after sampling and after having been frozen. The readings of frozen N
samples differed by `r 100*N_rat[1]`% and `r 100*N_rat[2]`%, and the readings of frozen P
samples differed by `r 100*P_rat[1]`% and `r 100*P_rat[2]`%, respectively. These differences are very small so the
samples were frozen and accumulated and assayed in batches.

```{r NutrientAssays}
# Create a table for displaying dates of assays
assay_df <- data.frame(obsdate = fw_df$obsdate,
                       frozen = fw_df$frozen,
                       assaydate = fw_df$assaydate,
                       daysfrozen = as.integer(fw_df$assaydate - fw_df$obsdate))

kable(assay_df)

# Create a data frame without the duplicate dates
assay_df <- fw_df[-c(nf_before[both_before_nf],nf_after[both_after_nf]),]

# Create a data frame for deltas between before/after using all data
before_df <- assay_df %>%
    filter(before == TRUE) %>%
    select(obsdate, PO4P, TN, pH)

after_df <- assay_df %>%
    filter(before == FALSE) %>%
    select(obsdate, PO4P, TN, pH)

Ndelta_df <- data.frame(obsdate = after_df[2:nrow(after_df),]$obsdate)
Ndelta_df$delta <- after_df[2:nrow(after_df),]$TN - before_df[1:nrow(before_df),]$TN

Pdelta_df <- data.frame(obsdate = after_df[2:nrow(after_df),]$obsdate)
Pdelta_df$delta <- after_df[2:nrow(after_df),]$PO4P - before_df[1:nrow(before_df),]$PO4P

pH_before <- which(!is.na(before_df$pH))
pH_after <- which(!is.na(after_df$pH))
pHdelta_df <- after_df[pH_after[(2:length(pH_after))],]$pH - before_df[pH_before,]$pH

# Numbers of days of treatment per assay (1st observation gets NA)
obsdays <- Ndelta_df$obsdate
obsdays <- c(NA, (obsdays[2:length(obsdays)] - obsdays[1:(length(obsdays)-1)]))

# Which observations had 1 or 4 days in between
obs1day <- which(obsdays == 1)
obs4day <- which(obsdays == 4)

# Observations with 1 day between observations
N1_df <- Ndelta_df[obs1day,]
P1_df <- Pdelta_df[obs1day,]

# Observations with 4 days between observations
N4_df <- Ndelta_df[obs4day,]
P4_df <- Pdelta_df[obs4day,]

# Correlations among all readings
Ncor_temp <- cor(Ndelta_df$delta, obs_df$temps)
Ncor_lux <- cor(Ndelta_df$delta, obs_df$lux)

Pcor_temp <- cor(Pdelta_df$delta, obs_df$temps)
Pcor_lux <- cor(Pdelta_df$delta, obs_df$lux)

Ncor_tl <- cor(Ndelta_df$delta, obs_df$temps * obs_df$luxs)
Pcor_tl <- cor(Pdelta_df$delta, obs_df$temps * obs_df$luxs)
```
### Total Nitrogen  

### PO4 Phosphate

### pH   

### Biomass
Algal biomass grows by

# Conclusions  
The FZ-J WWTP Pilot successfully demonstrated highly effective ATS treatment of secondary sewage, reducing

# Acknowledgements  
The authors would like to thank Christina Kuchendorf, Marian Roeb, and Philipp Norf for invaluable
assistance during this project.

# Tables
```{r Table1}
#kable(file)
```
# Figures

```{r, out.width=300, echo=FALSE}
knitr::include_graphics("http://apod.nasa.gov/apod/image/1302/ringshexagon_cass
ini_1016.jpg")
```