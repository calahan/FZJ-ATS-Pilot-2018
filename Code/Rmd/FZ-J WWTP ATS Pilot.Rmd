---
title: 'FZ-J WWTP ATS Pilot Data Analysis'
author: "Dean Calahan"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, fig.height=3)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```
```{r initialize}
library(readr)
library(readxl)
library(dplyr)
library(lubridate)
source("Code/R/Settings.R")
```

```{r Code}
HOBOData <- function(fn, zone="Europe/Berlin", trim=c(NA, NA), wind=c(NA, NA), view=TRUE, text=FALSE, ret=FALSE, week=NA) {
# i:
# fn        Name of the HOBO csv file to load
# trim      Number of observations to remove from beginning and end of data
# wind      Beginning and end indices of data to plot (if view==TRUE)
# view      Whether to plot the data
# text      Whether to display text with count of observations in the csv file
# ret       Whether to return the trimmed dataset
# week      Which week is represented by this file
#
    tb <- read_csv(paste0(csvdir, fn), skip=2, col_names=c(
        "id",
        "date",
        "time",
        "tmp",
        "lx")) %>% transmute(
            datetime = make_datetime(year(mdy(date)),
                                     month(mdy(date)),
                                     day(mdy(date)),
                                     hour(time),
                                     minute(time),
                                     second(time),
                                     tz=zone),
            temp=tmp,
            lux=lx
        )
    
    row_ct <- nrow(tb)
    
    # Adjust trim[2] to reflect actual index, not number of observations to remove
    if(is.na(trim[1])) {
        trim <- c(0, row_ct)
    } else {
    trim <- c(trim[1], row_ct - trim[2])
    }

    if(is.na(wind[1])) {
        wind <- c(1, row_ct)
    }

    if(text) {
        cat(paste0(fn, ": ", nrow(tb), " ", "observations\n"))
    }
    
    if(view) {
        par(mfrow=c(1,2))
        
        plot(x=tb[wind[1]:wind[2],]$datetime,
             y=tb[wind[1]:wind[2],]$lux,
             type="l",
             main=paste0("lux ", fn),
             xlab="Date",
             ylab="Lux")
        
        abline(v=c(tb[trim[1],]$datetime,
                   tb[trim[2],]$datetime),
               col=c("blue", "blue"),
               lty=c(1, 1),
               lwd=c(1, 1))
        
        plot(x=tb[wind[1]:wind[2],]$datetime,
             y=tb[wind[1]:wind[2],]$temp,
             type="l",
             main=paste0("temp ", fn),
             xlab="Date",
             ylab="Temperature")
        
        abline(v=c(tb[trim[1],]$datetime,
                   tb[trim[2],]$datetime),
               col=c("blue", "blue"),
               lty=c(1, 1),
               lwd=c(1, 1))
        
    }
    
    if(!is.na(week)) {
        tb$week <- week
    }
    
    if(ret) {
        return(tb[trim[1]:trim[2],])
    }
}

CleanHOBOData <- function(fn, l, r, w) {
    tb <- HOBOData(fn, view=FALSE, ret=TRUE, week=w)
    row_ct <- nrow(tb)
    HOBOData(fn, trim=c(l, r))
    HOBOData(fn, trim=c(l, r), wind=c(l-50, l+50))
    HOBOData(fn, trim=c(l, r), wind=c(row_ct-r-50, row_ct-r+50))
    return(tb[l:(row_ct-r),])
}

csvfiles <- c("ATS_1.11.09.18.csv",
           "ATS_2.17.09.18.csv",
           "ATS_1.24.09.18.csv",
           "ATS_2.01.10.18.csv",
           "ATS_1.08.10.18.csv",
           "ATS_2.15.10.18.csv",
           "ATS_1.22.10.18.csv")

chemfile <- paste0(ssdir, "ATS Treatment.xlsx")
```
# Introduction  
Forshungzentrum-JÃ¼lich's (FZ-J) IBG-2 Alternative Biomass group installed a pilot
algal turf scrubber (ATS) at its campus wastewater treatment plant (WWTP) in mid-August
of 2018. This facility comprised a dump bucket and floway with approximately 1m^2^
algal growth area, and recirculated 500 L of secondary treated sewage for periods
of 24 hr (Monday through Thursday) and 96 hr (Thursday through Sunday). Beginning
in early September, the facility was harvested weekly, and elementary water chemistry,
illumination, temperature, and biomass productivity data were collected. The facility
was removed from the WWTP at the end of September. This document describes the data
collection for this pilot project and summarizes the results.  

## Temperature and Illumination Data Logging  
Two HOBO data loggers (ATS_1 and ATS_2) were used to gather temperature and illumination
data, with one observation recorded per minute. Each week one logger was active, installed in the floway,
while the other logger was idle. Prior to weekly harvest, the idle logger was initialized and was then used to replace
the active logger after harvest. Data was then downloaded from the prior week's active logger.
Each data file was processed using the HOBOware software, to export csv files containing
temperature and illumination data.

## Temperature and Illumination Data Cleaning
The data from each HOBO csv file was plotted and visually inspected to determine which observations
reflected either the interval between initialization and installation in the floway, or the interval between
removing the logger and downloading its data. The results of this analysis are shown in the Figures
section of this document, with blue vertical lines enclosing the window of valid observations. Each
complete plot is followed my magnifications of each cutoff region. In general it was obvious from temperature and/or illumination readings which were the critical observations. During the data cleaning process, the cleaned data
is accumulated into a single data frame and then saved.

# Data Analaysis

# Figures  
### Temperature and Illumination, Week 1 (ATS_1)  
```{r week1}
ti_df <- CleanHOBOData(csvfiles[1], 1010, 365, w=1)
```

### Temperature and Illumination, Week 2 (ATS_2)  
```{r week2}
ti_df <- ti_df %>% rbind(CleanHOBOData(csvfiles[2], 9773, 271, w=2))
```

### Temperature and Illumination, Week 3 (ATS_1)  
```{r week3}
ti_df <- ti_df %>% rbind(CleanHOBOData(csvfiles[3], 119, 96, w=3))
```

### Temperature and Illumination, Week 4 (ATS_2)  
```{r week4}
ti_df <- ti_df %>% rbind(CleanHOBOData(csvfiles[4], 107, 227, w=4))
```

### Temperature and Illumination, Week 5 (ATS_1)  
```{r week5}
ti_df <- ti_df %>% rbind(CleanHOBOData(csvfiles[5], 107, 227, w=5))
```

### Temperature and Illumination, Week 6 (ATS_2)  
```{r week6}
ti_df <- ti_df %>% rbind(CleanHOBOData(csvfiles[6], 121, 65, w=6))
```

### Temperature and Illumination, Week 7 (ATS_1)  
```{r week7}
ti_df <- ti_df %>% rbind(CleanHOBOData(csvfiles[7], 84, 54, w=7))
write_csv(data, paste0(datadir, "FZJATSPilot.csv"))
```

# Floway Chemistry & Biomass
```{r Floway}
wc_df <- read_excel(chemfile,
                    sheet="Tabelle1",
                    skip=3,
                    col_names=c("date",
                               "time",
                               "beforeafter",
                               "PO4dil",
                               "PO4P",
                               "PO4Pxdil",
                               "PO4Pred",
                               "dilTN",
                               "TNxdil",
                               "TN",
                               "TNred",
                               "comment",
                               "remark",
                               "assaydate",
                               "bmwet",
                               "bmdry",
                               "bmdrypct",
                               "pH"))

# Impute 8:00 for missing times. This is for a potentially meaningless sense of completeness as the
# time value is not actually used for any calculations. Howver it could be used to confirm/refine the 
# data trimming windows.
wc_df[which(is.na(wc_df$time)),]$time <- make_datetime(2018,
                                                       12,
                                                       31,
                                                       8,
                                                       0,
                                                       0)

# Create a new data frame with date and time combined into datetime for each observation
fw_df <- data.frame(datetime=make_datetime(year(wc_df$date),
                                           month(wc_df$date),
                                           day(wc_df$date),
                                           hour(wc_df$time),
                                           minute(wc_df$time),
                                           second(wc_df$time),
                                           tz="Europe/Berlin"))

# Make before/after a logical
fw_df$before <- TRUE
fw_df[which(wc_df$beforeafter != "before"),]$before <- FALSE

# Nutrient concentrations & pH
fw_df$PO4P <- wc_df$PO4P
fw_df$TN <- wc_df$TN
fw_df$pH <- wc_df$pH

# Make frozen/not frozen a logical
fw_df$frozen <- TRUE
fw_df[which(wc_df$comment != "frozen"),]$frozen <- FALSE

# Date of assay
fw_df$assaydate <- make_date(year(wc_df$assaydate),
                                 month(wc_df$assaydate),
                                 day(wc_df$assaydate))

# Add a week number corresponding to ti_df
week_num_days <- function(x) {
    return(c(min(ti_df[ti_df$week == x,]$datetime), max(ti_df[ti_df$week == x,]$datetime)))
}

# Biomass measurements
fw_df$wet_biomass <- wc_df$bmwet
fw_df$dry_biomass <- wc_df$bmdry
fw_df$solids <- wc_df$bmdrypct
```

## Correlation of nutrient removal with temperature and illumination.  
We initially assume that nutrient removal is a function of algal metabolic activity,
which itself we assume is a function of temperature and illumination. We first
integrate these observations for each nutrient assay interval by converting degrees
Celsius to degrees Kelvin, summing the temperatures and illumination readings for each
interval to obtain values for "degree minutes" (DM) and "lux minutes" (LM). For each interval
we then multiply DM x LM and plot these values against nutrient removal for that interval.

```{r DMLM1}
unique(wday(wc_df[wc_df$week == 1,]$datetime))

```

To integrate temperature data we convert degrees Celsius to degrees Kelvin then sum