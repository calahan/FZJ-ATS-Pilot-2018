---
title: 'FZ-J WWTP ATS Pilot Data Analysis'
author: "Dean Calahan"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, fig.height=3)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```
```{r initialize}
library(readr)
library(readxl)
library(dplyr)
library(lubridate)
source("Code/R/Settings.R")
```

```{r Code}
HOBOData <- function(fn, zone="Europe/Berlin", trim=c(NA, NA), wind=c(NA, NA), view=TRUE, text=FALSE, ret=FALSE, week=NA) {
#
# i:
# fn        Name of the HOBO csv file to load
# trim      Number of observations to remove from beginning and end of data
# wind      Beginning and end indices of data to plot (if view==TRUE)
# view      Whether to plot the data
# text      Whether to display text with count of observations in the csv file
# ret       Whether to return the trimmed dataset
# week      Which week is represented by this file
#
# o:        If requested, a tibble containing the HOBO data from the specified file, with first
#           and last data elided.
#
# s:        A plot is generated if requested, displaying the data within the specified window
#
    tb <- read_csv(paste0(csvdir, fn), skip=2, col_names=c(
        "id",
        "date",
        "time",
        "tmp",
        "lx")) %>% transmute(
            datetime = make_datetime(year(mdy(date)),
                                     month(mdy(date)),
                                     day(mdy(date)),
                                     hour(time),
                                     minute(time),
                                     second(time),
                                     tz=zone),
            temp=tmp,
            lux=lx
        )
    
    row_ct <- nrow(tb)
    
    # Adjust trim[2] to reflect actual index, not number of observations to remove
    if(is.na(trim[1])) {
        trim <- c(0, row_ct)
    } else {
    trim <- c(trim[1], row_ct - trim[2])
    }

    if(is.na(wind[1])) {
        wind <- c(1, row_ct)
    }

    if(text) {
        cat(paste0(fn, ": ", nrow(tb), " ", "observations\n"))
    }
    
    if(view) {
        par(mfrow=c(1,2))
        
        plot(x=tb[wind[1]:wind[2],]$datetime,
             y=tb[wind[1]:wind[2],]$lux,
             type="l",
             main=paste0("lux ", fn),
             xlab="Date",
             ylab="Lux")
        
        abline(v=c(tb[trim[1],]$datetime,
                   tb[trim[2],]$datetime),
               col=c("blue", "blue"),
               lty=c(1, 1),
               lwd=c(1, 1))
        
        plot(x=tb[wind[1]:wind[2],]$datetime,
             y=tb[wind[1]:wind[2],]$temp,
             type="l",
             main=paste0("temp ", fn),
             xlab="Date",
             ylab="Temperature")
        
        abline(v=c(tb[trim[1],]$datetime,
                   tb[trim[2],]$datetime),
               col=c("blue", "blue"),
               lty=c(1, 1),
               lwd=c(1, 1))
        
    }
    
    if(!is.na(week)) {
        tb$week <- week
    }
    
    if(ret) {
        return(tb[trim[1]:trim[2],])
    }
}

CleanHOBOData <- function(fn, l, r, w) {
    tb <- HOBOData(fn, view=FALSE, ret=TRUE, week=w)
    row_ct <- nrow(tb)
    HOBOData(fn, trim=c(l, r))
    HOBOData(fn, trim=c(l, r), wind=c(l-50, l+50))
    HOBOData(fn, trim=c(l, r), wind=c(row_ct-r-50, row_ct-r+50))
    return(tb[l:(row_ct-r),])
}

csvfiles <- c("ATS_1.11.09.18.csv",
           "ATS_2.17.09.18.csv",
           "ATS_1.24.09.18.csv",
           "ATS_2.01.10.18.csv",
           "ATS_1.08.10.18.csv",
           "ATS_2.15.10.18.csv",
           "ATS_1.22.10.18.csv")

chemfile <- paste0(ssdir, "ATS Treatment.xlsx")
```
# Introduction  
Forshungzentrum-JÃ¼lich's (FZ-J) IBG-2 Alternative Biomass group installed a pilot
algal turf scrubber (ATS) at its campus wastewater treatment plant (WWTP) in mid-August
of 2018. This facility comprised a dump bucket and floway with approximately 1m^2^
algal growth area, and recirculated 500 L of secondary treated sewage for periods
of 24 hr (Monday through Thursday) and 96 hr (Thursday through Sunday). Beginning
in early September, the facility was harvested weekly, and elementary water chemistry,
illumination, temperature, and biomass productivity data were collected. The facility
was removed from the WWTP at the end of September. This document describes the data
collection for this pilot project and summarizes the results.  

## Temperature and Illumination Data Logging  
Two HOBO data loggers (ATS_1 and ATS_2) were used to gather temperature and illumination
data, with one observation recorded per minute. Each week one logger was active, installed in the floway,
while the other logger was idle. Prior to weekly harvest, the idle logger was initialized and was then used to replace
the active logger after harvest. Data was then downloaded from the prior week's active logger.
Each data file was processed using the HOBOware software, to export csv files containing
temperature and illumination data.

## Temperature and Illumination Data Cleaning
The data from each HOBO csv file was plotted and visually inspected to determine which observations
reflected either the interval between initialization and installation in the floway, or the interval between
removing the logger and downloading its data. The results of this analysis are shown in the Figures
section of this document, with blue vertical lines enclosing the window of valid observations. Each
complete plot is followed my magnifications of each cutoff region. In general it was obvious from temperature and/or illumination readings which were the critical observations. During the data cleaning process, the cleaned data
is accumulated into a single data frame and then saved.

# Data Analaysis

# Figures  
### Temperature and Illumination, Week 1 (ATS_1)  
```{r week1}
ti_df <- CleanHOBOData(csvfiles[1], 1010, 365, w=1)
```

### Temperature and Illumination, Week 2 (ATS_2)  
```{r week2}
ti_df <- ti_df %>% rbind(CleanHOBOData(csvfiles[2], 9773, 271, w=2))
```

### Temperature and Illumination, Week 3 (ATS_1)  
```{r week3}
ti_df <- ti_df %>% rbind(CleanHOBOData(csvfiles[3], 119, 96, w=3))
```

### Temperature and Illumination, Week 4 (ATS_2)  
```{r week4}
ti_df <- ti_df %>% rbind(CleanHOBOData(csvfiles[4], 107, 227, w=4))
```

### Temperature and Illumination, Week 5 (ATS_1)  
```{r week5}
ti_df <- ti_df %>% rbind(CleanHOBOData(csvfiles[5], 107, 227, w=5))
```

### Temperature and Illumination, Week 6 (ATS_2)  
```{r week6}
ti_df <- ti_df %>% rbind(CleanHOBOData(csvfiles[6], 121, 65, w=6))
```

### Temperature and Illumination, Week 7 (ATS_1)  
```{r week7}
ti_df <- ti_df %>% rbind(CleanHOBOData(csvfiles[7], 84, 54, w=7))
write_csv(ti_df, paste0(datadir, "FZJATSPilot.csv"))
```

# Floway Chemistry & Biomass
```{r Floway}
wc_df <- read_excel(chemfile,
                    sheet="Tabelle1",
                    skip=3,
                    col_names=c("date",
                               "time",
                               "beforeafter",
                               "PO4dil",
                               "PO4P",
                               "PO4Pxdil",
                               "PO4Pred",
                               "dilTN",
                               "TNxdil",
                               "TN",
                               "TNred",
                               "comment",
                               "remark",
                               "assaydate",
                               "bmwet",
                               "bmdry",
                               "bmdrypct",
                               "pH"))

# Impute missing times. We take the minimum time, and simply add 24 hours to it
no_times <- which(is.na(wc_df$time))
min_time <- min(ti_df[ti_df$week == 1,]$datetime)
wc_df[which(is.na(wc_df$time)),]$time <- make_datetime(2018,
                                                       12,
                                                       31,
                                                       8,
                                                       0,
                                                       0)

# Create a new data frame with date and time combined into datetime for each observation
fw_df <- data.frame(datetime=make_datetime(year(wc_df$date),
                                           month(wc_df$date),
                                           day(wc_df$date),
                                           hour(wc_df$time),
                                           minute(wc_df$time),
                                           second(wc_df$time),
                                           tz="Europe/Berlin"))

# Make before/after a logical
fw_df$before <- TRUE
fw_df[which(wc_df$beforeafter != "before"),]$before <- FALSE

# Nutrient concentrations & pH
fw_df$PO4P <- wc_df$PO4Pxdil
fw_df$TN <- wc_df$TN
fw_df$pH <- wc_df$pH

# Make frozen/not frozen a logical
fw_df$frozen <- TRUE
fw_df[which(wc_df$comment != "frozen"),]$frozen <- FALSE

# Date of assay
fw_df$assaydate <- make_date(year(wc_df$assaydate),
                                 month(wc_df$assaydate),
                                 day(wc_df$assaydate))

# Add a week number corresponding to ti_df
# week_num_dates <- function(x) {
#     t <- unique(make_date(year(ti_df[ti_df$week == x,]$datetime),
#                      month(ti_df[ti_df$week == x,]$datetime),
#                      day(ti_df[ti_df$week == x,]$datetime)))
#     return(c(min(t), max(t)))
# }
# t <- week_num_dates(1)
# which(fw_df$datetime >= t[1] & fw_df$datetime <= t[2])

# Biomass measurements
fw_df$wet_biomass <- wc_df$bmwet
fw_df$dry_biomass <- wc_df$bmdry
fw_df$solids <- wc_df$bmdrypct

# Need observation date separately to make life easier
fw_df$obsdate <- make_date(year(fw_df$datetime), month(fw_df$datetime), day(fw_df$datetime))
```

## Correlation of nutrient removal with temperature and illumination.  
We initially assume that nutrient removal is a function of algal metabolic activity,
which itself we assume is a function of temperature and illumination. We first
integrate these observations for each nutrient assay interval by converting degrees
Celsius to degrees Kelvin, summing the temperatures and illumination readings for each
interval to obtain values for "degree minutes" (DM) and "lux minutes" (LM). For each interval
we then multiply DM x LM and plot these values against nutrient removal for that interval.

```{r DMLM}
# A global list of unique dates of nutrient assays
nutdates <- sort(unique(make_date(year(fw_df$datetime), month(fw_df$datetime), day(fw_df$datetime))))

IntegrateObs <- function(day, diag=FALSE) {
#
# i:    startdate
#
# o:    The number of degree minutes between the observation time of the given start date
#       and the next observation time
#
# g:    
#
    # Day 1 is an error because there was no previous sample
    if(day == 1) {
        stop("Day 1 illegal")
    }
    
    # If day is larger than number of observations, it is an error
    if(day > length(nutdates)) {
        stop("Day too large")
    }
    
    # What are the bracketing datetimes
    t2 <- min(fw_df[which(year(fw_df$datetime) == year(nutdates[day]) &
                         month(fw_df$datetime) == month(nutdates[day]) &
                         day(fw_df$datetime) == day(nutdates[day])),]$datetime)
    
    t1 <- min(fw_df[which(year(fw_df$datetime) == year(nutdates[day-1]) &
                         month(fw_df$datetime) == month(nutdates[day-1]) &
                         day(fw_df$datetime) == day(nutdates[day-1])),]$datetime)
    
    # What are the temperature and lux measurements between these brackets?
    temps <- ti_df[ti_df$datetime >= t1 & ti_df$datetime < t2,]$temp + C2K
    luxs <-  ti_df[ti_df$datetime >= t1 & ti_df$datetime < t2,]$lux
    
    if(diag) {
        cat(paste0("Number of observations: ", length(temps), "\n"))
    }
    
    return(c(sum(temps), sum(luxs)))
}

int_obs <- t(simplify2array(lapply(2:26, IntegrateObs)))
obs_df <- data.frame(datetime=nutdates[2:26], temps=int_obs[,1], luxs=int_obs[,2])
plot(obs_df$datetime, obs_df$temps, type="h")
```

To integrate temperature and illumination data we sum the values (after converting temperature from degrees
Celsius to degrees Kelvin) approximate for each interval between N and P assays. 

## Validity of nutrient assays of frozen samples
```{r Frozen}
# Which assays had results for both frozen and non-frozen samples?
#
# First get indices of before/after for frozen/nonfrozen samples
nf_before <- which(fw_df$frozen == FALSE & fw_df$before == TRUE)
nf_after <- which(fw_df$frozen == FALSE & fw_df$before == FALSE)
f_before <- which(fw_df$frozen == TRUE & fw_df$before == TRUE)
f_after <- which(fw_df$frozen == TRUE & fw_df$before == FALSE)

# Then, for each assay that was frozen, was there a frozen assay for that date,
# And for each assay that wasn't frozen, was there an unfrozen assay for that date
both_before_nf <- fw_df[nf_before,]$obsdate %in% fw_df[f_before,]$obsdate
both_after_nf <- fw_df[nf_after,]$obsdate %in% fw_df[f_after,]$obsdate
both_before_f <- fw_df[f_before,]$obsdate %in% fw_df[nf_before,]$obsdate
both_after_f <- fw_df[f_after,]$obsdate %in% fw_df[nf_after,]$obsdate

# What are the dates for all those
nf_before_dates <- fw_df[nf_before[both_before_nf],]$obsdate
# nf_after_dates <- fw_df[nf_after[both_after_nf],]$obsdate
# f_before_dates <- fw_df[f_before[both_before_f],]$obsdate
# f_after_dates <- fw_df[f_after[both_after_f],]$obsdate

# What are the differences between the measurements
N_nf_before <- fw_df[nf_before[both_before_nf],]$TN
N_f_before <- fw_df[f_before[both_before_f],]$TN
P_nf_before <- fw_df[nf_before[both_before_nf],]$PO4P
P_f_before <- fw_df[f_before[both_before_f],]$PO4P

N_rat <- (N_nf_before - N_f_before) / N_nf_before
P_rat <- (P_nf_before - P_f_before) / P_nf_before
```
Samples taken on `r nf_before_dates[1]` and `r nf_before_dates[2]` were assayed both
immediately after sampling and after having been frozen.
