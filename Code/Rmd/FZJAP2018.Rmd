---
title: 'FZJ ATS Pilot 2018'
author:
- Dean Calahan^[Smithsonian Institution, Forschungszentrum Jülich]
- Isabel Meuser and Ladislav Nedbal^[Forschungszentrum Jülich]
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
---

```{r header}
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
#
# Copyright 2018-2019 by Forschungszentrum-Jülich (FZ-J)
#
# This file is part of the publication "FZJ ATS Pilot 2018" (FZJAP2018), a data
# set documenting the results of an algal turf scrubbing pilot project performed
# 15.07-15.09 2018, treating secondary sewage at FZ-J's campus wastewater treatment
# plant.
#
# The software component of FZJAP2018 is open access: you can redistribute it and/or
# modify it under the terms of the GNU General Public License as published by the
# Free Software Foundation, either version 3 of the License, or (at your option)
# any later version.
#
# The software component of FZJAP2018 is distributed in the hope that it will be
# useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
# details.
#
# You should have received a copy of the GNU General Public License along with the
# software component of FZJAP2018. If not, see <http://www.gnu.org/licenses/>.
#
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, fig.height=3)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```
```{r initialize}
source("Code/R/Settings.R")
source("Code/R/FZJAP2018.R")
# Execute the following command to knit, rather than use the knit button.
# rmarkdown::render("Code/Rmd/FZJAP2018.Rmd", output_dir="Drafts", output_format = c("html_document",  "pdf_document", "word_document"))
#
# [todo] Figure out the source of errors when using the following header to create
# a Word document. Pperhaps setting root.dir is causative. Perhaps the environment
# is getting disrupted.
#
# output 
#   html_document: default
#   pdf_document: default
#   word_document: default
# knit: (function(inputFile, encoding) {
#   rmarkdown::render(inputFile, encoding = encoding,
#   output_dir = "output", output_format = "all") })
```
# Introduction  
Here we clean the data from the 2018 ATS pilot at Forschungszentrum-Jülich and generate
csv files for further analysis. Temperature and irradiance data were downloaded
weekly from a HOBO data logger. Water quality data was obtained by using standardized
kits. Biomass productivity data was obtained by weighing wet and dried biomass harvested
from a defined portion of the floway surface. Water quality and biomass data were
entered manually into the spreadsheet `ATS Treatment.xlsx`. Biomass composition
data was obtained by standard analyses and stored in the spreadsheet `Analysen ZEA-3.xlsx`.

To clean the temperature and irradiance data, each week's data file (`ATS_<#.dd.mm.yy>.hobo`)
was converted csv using the Onset's HOBOware software (note that the files `*.hproj`
contain metadata bout the `.hobo` files and were not processed). Because the data
loggers were either initialized in an office before being transported to the floway
for installation, or downloaded after being removed from the floway and taken to
the office, the initial and final observations had to be discarded. Figures 1-7
and the code that generated them show which observations were discarded. The remaining
observations were combined into a single data set and saved as a csv file. To clean
the water quality and biomass data, recorded manually in an Excel spreadsheet, the
spreadsheet data were loaded and manipulated into a schema more useful for analysis
before being saved as a csv file.

# Data Set Descriptions
## Temperature and irradiance
Each week's data is shown in several views, for both irradiance and temperature.
First the entire data set is shown, with vertical blue lines indicating either the
earliest observation that was retained (right hand side) or the latest observation
that was retained (left hand side). This global view is followed by a magnification
of the early and late regions. The numbers in the function call that performs the
data cleaning refer to how many observations are removed from the beginning and
end of the data set, respectively.

## Water Quality, Biomass Productivity, Biomass Composition
Some of the columns of `ATS Treatment.xlsx` ("Dilution PO4-P", "PO4-P", "reduction",
"Dilution TNb", "TNb", "remark"), were not retained in the cleaned data, while others
(unnamed column with "before/after", "commend") were converted from text to logical
for improved ease of analysis. All of the columns of `Analysen ZEA-3.xlsx` were
retained.

\newpage
# Data Cleaning.  
## HOBO Data. `Week # (name of data logger)`
### Week 1 (ATS_1)  
```{r week1}
# Create cleaned data set from the first week.
ti_df <- CleanHOBOData(HOBO_fn[1], 1010, 365, w=1)
```

### Week 2 (ATS_2)  
```{r week2}
# Clean and append the data set from the following week.
ti_df <- ti_df %>% rbind(CleanHOBOData(HOBO_fn[2], 9773, 271, w=2))
```

### Week 3 (ATS_1)  
```{r week3}
# Clean and append the data set from the following week.
ti_df <- ti_df %>% rbind(CleanHOBOData(HOBO_fn[3], 119, 96, w=3))
```

### Week 4 (ATS_2)  
```{r week4}
# Clean and append the data set from the following week.
ti_df <- ti_df %>% rbind(CleanHOBOData(HOBO_fn[4], 107, 227, w=4))
```

### Week 5 (ATS_1)  
```{r week5}
# Clean and append the data set from the following week.
ti_df <- ti_df %>% rbind(CleanHOBOData(HOBO_fn[5], 107, 227, w=5))
```

### Week 6 (ATS_2)  
```{r week6}
# Clean and append the data set from the following week.
ti_df <- ti_df %>% rbind(CleanHOBOData(HOBO_fn[6], 121, 65, w=6))
```

### Week 7 (ATS_1)  
```{r week7}
# Clean and append the data set from the following week.
ti_df <- ti_df %>% rbind(CleanHOBOData(HOBO_fn[7], 84, 54, w=7))
```
```{r save_ti}
# Save the data set as a csv file
write_csv(ti_df, ti_fn)
```

# Floway Chemistry & Biomass Productivity
On two occasions, samples were assayed both on the day they were taken and after
freezing (Table 1). As the absolute differences between the readings for frozen
and unfrozen samples was small, less than 5% except for two measurements, it was
decided to freeze and accumulate samples for collective analysis rather than assay
each sample on the day it was collected.  

```{r WaterChemistryBiomass}
# Load and clean the data in "ATS Treatment.xlsx"
wcb_df <- WaterChemistryBiomass(ti_df)

# Display data for samples assayed both frozen and fresh
#kable(WaterChemistryBiomassDupes())

# Split the data into water chemistry and biomass productivity.
wc_df <- wcb_df %>%
    select(datetime, before, PO4P, TN, pH, frozen, assaydate, obsdate)

bp_df <- wcb_df %>%
    filter(!is.na(wet_biomass)) %>%
    select(wet_biomass, dry_biomass, obsdate)

# Save the water chemistry data, cleaned by removing duplicates.
wc_df <- wc_df[c(1:2, 4, 6:12, 14, 16:55),]
write_csv(wc_df, wc_fn)

# Save the cleaned biomass productivity data
write_csv(bp_df, bp_fn)
```

# Biomass Composition Data
```{r BiomassCompositionData}
# Load cleaned biomass composition data from the spreadsheet.
bc_df <- BiomassCompositionData(bcd)
write_csv(bc_df, bc_fn)

# Plot biomass composition data.
PlotBiomassCompositionData(bc_df)
PlotMeanBiomassCompositionData(bc_df)
PlotMolarRatios(bc_df)
```

# Data Dictionaries 

```{r bcdd}
# id
# date
# atom
# proportion
# sd
kable(data.frame(Column = colnames(bc_df),
                 Description = c("Observation ID",
                                 "Harvest date",
                                 "Element assayed",
                                 "Mass proportion of element in sample",
                                 "Standard deviation with n = 2")),
      caption = bc_fn)

# wet_biomass
# dry_biomass
# obsdate
kable(data.frame(Column = colnames(bp_df),
                 Description = c("Mass of total fresh biomass harvested",
                                 "Mass of total dried biomass",
                                 "Harvest date")),
      caption = bp_fn)

# datetime
# temp
# lux
# week
kable(data.frame(Column = colnames(ti_df),
                 Description = c("Date and time of observation",
                                 "Temperature (°C)",
                                 "Irradiance (lux)",
                                 "Week index")),
      caption = ti_fn)

# datetime
# before
# PO4P
# TN
# pH
# frozen
# assaydate
# obsdate
kable(data.frame(Column = colnames(wc_df),
                 Description = c("Date and time of observation",
                                 "Was this sample taken before or after water exchange?",
                                 "Soluble P04, mg L-1",
                                 "Total N, mg L-1",
                                 "ph",
                                 "Was this sample frozen?",
                                 "Date sample was assayed",
                                 "Observation date")),
      caption = wc_fn)


```